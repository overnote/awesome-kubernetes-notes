

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>三 集群部署 &mdash; Zeusro&#39;s awesome-kubernetes-notes 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="四 入门命令" href="chapter_4.html" />
    <link rel="prev" title="二 核心组件/附件" href="chapter_2.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Zeusro's awesome-kubernetes-notes
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter_0.html">关于“我”</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_1.html">一 Kubernetes概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_2.html">二 核心组件/附件</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">三 集群部署</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">3.1 部署前准备</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#firewalld-selinux">3.1.1 关闭 firewalld 和 selinux</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ipvs">3.1.2 加载 ipvs 内核模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-k8s">3.1.3 下载 Docker 和 K8S</a></li>
<li class="toctree-l3"><a class="reference internal" href="#k8s">3.1.4 设置内核及 K8S 参数</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#master">3.2 部署 Master</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">3.2.1 提前拉取镜像</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">3.2.2 初始化Master</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#node">3.3 部署 Node</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">3.3.1 加入集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">3.3.2 查看进度</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">3.3.3 镜像下载太慢</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="chapter_4.html">四 入门命令</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_5.html">五 配置清单使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter_6.html">六 集群故障管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html">七 控制器配置清单</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#service">八 Service 配置清单</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#ingress">九 ingress 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#pod">十 POD 存储卷</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id25">十一 配置信息容器化</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#statefulset">十二 StatefulSet 控制器</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id33">十三 用户认证系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id40">十四 用户权限系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#dashboard">十五 dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id46">十六 网络通信</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id55">十七 调度策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id62">十八 高级调度设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id68">十九 容器资源限制</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#heapster">二十 HeapSter监控（废弃中）</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id71">二十一 新一代监控架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#id75">二十二 K8S包管理器</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#etcd">二十三 ETCD详解</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-kubernetes-notes.html#kubesphere">二十四 国产容器管理平台KubeSphere实战排错</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Zeusro's awesome-kubernetes-notes</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>三 集群部署</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/chapter_3.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>三 集群部署<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>为简单上手体验功能，可以先利用kubeadm安装测试，生产环境建议二进制或者一些成熟的集群高可用安装方式，Kubeadm
是 K8S 官方提供的快速部署工具，它提供了 kubeadm init 以及 kubeadm join
这两个命令作为快速创建 kubernetes 集群的最佳实践，本章节说明了使用
kubeadm 来部署 K8S 集群的过程。</p>
<ul class="simple">
<li><p>集群组织结构</p></li>
</ul>
<blockquote>
<div><p>项目说明 —————————————————–
集群规模
Master、node1、node2 系统 CentOS 7.3 网络规划
POD：10.244.0.0/16、Service：10.96.0.0/12</p>
</div></blockquote>
<div class="section" id="id2">
<h2>3.1 部署前准备<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>本小节的所有的操作，在所有的节点上进行</p>
</div></blockquote>
<div class="section" id="firewalld-selinux">
<h3>3.1.1 关闭 firewalld 和 selinux<a class="headerlink" href="#firewalld-selinux" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>setenforce <span class="m">0</span>
sed -i <span class="s1">&#39;/^SELINUX=/cSELINUX=disabled&#39;</span> /etc/selinux/config

systemctl stop firewalld
systemctl disable firewalld
</pre></div>
</div>
</div>
<div class="section" id="ipvs">
<h3>3.1.2 加载 ipvs 内核模块<a class="headerlink" href="#ipvs" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>安装 IPVS 模块</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>yum -y install ipvsadm ipset sysstat conntrack libseccomp
</pre></div>
</div>
<ul class="simple">
<li><p>设置开机加载配置文件</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat &gt;&gt;/etc/modules-load.d/ipvs.conf<span class="s">&lt;&lt;EOF</span>
<span class="s">ip_vs_dh</span>
<span class="s">ip_vs_ftp</span>
<span class="s">ip_vs</span>
<span class="s">ip_vs_lblc</span>
<span class="s">ip_vs_lblcr</span>
<span class="s">ip_vs_lc</span>
<span class="s">ip_vs_nq</span>
<span class="s">ip_vs_pe_sip</span>
<span class="s">ip_vs_rr</span>
<span class="s">ip_vs_sed</span>
<span class="s">ip_vs_sh</span>
<span class="s">ip_vs_wlc</span>
<span class="s">ip_vs_wrr</span>
<span class="s">nf_conntrack_ipv4</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置开机加载 IPVS 模块</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> systemd-modules-load.service   <span class="c1"># 设置开机加载内核模块</span>
lsmod <span class="p">|</span> grep -e ip_vs -e nf_conntrack_ipv4      <span class="c1"># 重启后检查 ipvs 模块是否加载</span>
</pre></div>
</div>
<ul class="simple">
<li><p>如果集群已经部署在了 iptables 模式下，可以通过下面命令修改，修改
mode 为 ipvs 重启集群即可。</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl edit -n kube-system configmap kube-proxy
</pre></div>
</div>
</div>
<div class="section" id="docker-k8s">
<h3>3.1.3 下载 Docker 和 K8S<a class="headerlink" href="#docker-k8s" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>设置 docker 源</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -o /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</pre></div>
</div>
<ul class="simple">
<li><p>设置 k8s 源</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat &gt;&gt;/etc/yum.repos.d/kuberetes.repo<span class="s">&lt;&lt;EOF</span>
<span class="s">[kuberneres]</span>
<span class="s">name=Kubernetes</span>
<span class="s">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span>
<span class="s">gpgcheck=0</span>
<span class="s">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span>
<span class="s">enabled=1</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ul class="simple">
<li><p>安装 docker-ce 和 kubernetes</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>yum install docker-ce kubelet kubectl kubeadm -y
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl start docker
systemctl <span class="nb">enable</span> docker
systemctl <span class="nb">enable</span> kubelet
</pre></div>
</div>
</div>
<div class="section" id="k8s">
<h3>3.1.4 设置内核及 K8S 参数<a class="headerlink" href="#k8s" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>设置内核参数</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat &gt;&gt;/etc/sysctl.conf<span class="s">&lt;&lt;EOF</span>
<span class="s">net.bridge.bridge-nf-call-ip6tables = 1</span>
<span class="s">net.bridge.bridge-nf-call-iptables = 1</span>
<span class="s">net.ipv4.ip_forward = 1</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置 kubelet 忽略 swap，使用 ipvs</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat &gt;/etc/sysconfig/kubelet<span class="s">&lt;&lt;EOF</span>
<span class="s">KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</span>
<span class="s">KUBE_PROXY_MODE=ipvs</span>
<span class="s">EOF</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="master">
<h2>3.2 部署 Master<a class="headerlink" href="#master" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>本小节的所有的操作，只在 Master 节点上进行</p>
</div></blockquote>
<div class="section" id="id3">
<h3>3.2.1 提前拉取镜像<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>宿主机最好能访问国外资源，在kubeadm init 在初始化的时候会到谷歌的 docker
hub 拉取镜像，如果宿主机测试无法访问 k8s.gcr.io
可以在服务器所以我们要提前部署好代理软件，本例中监听个本机 9666
进行部署。</p>
<p>如果条件不允许可以参考:
<a class="reference external" href="https://blog.csdn.net/jinguangliu/article/details/82792617">https://blog.csdn.net/jinguangliu/article/details/82792617</a>
来解决镜像问题。</p>
<ul class="simple">
<li><p>配置 Docker 拉取镜像时候的代理地址，vim
/usr/lib/systemd/system/docker.service。</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">&quot;HTTPS_PROXY=127.0.0.1:9666&quot;</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">&quot;NO_PROXY=127.0.0.0/8,172.16.0.0/16&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>提前拉取初始化需要的镜像</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm config images pull
</pre></div>
</div>
<ul class="simple">
<li><p>使用其他源镜像</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker pull mirrorgooglecontainers/kube-apiserver:v1.14.2
docker pull mirrorgooglecontainers/kube-controller-manager:v1.14.2
docker pull mirrorgooglecontainers/kube-scheduler:v1.14.2
docker pull mirrorgooglecontainers/kube-proxy:v1.14.2
docker pull mirrorgooglecontainers/pause:3.1
docker pull mirrorgooglecontainers/etcd:3.3.10
docker pull coredns/coredns:1.3.1


利用<span class="sb">`</span>kubeadm config images list<span class="sb">`</span> 查看需要的docker image name

k8s.gcr.io/kube-apiserver:v1.14.2
k8s.gcr.io/kube-controller-manager:v1.14.2
k8s.gcr.io/kube-scheduler:v1.14.2
k8s.gcr.io/kube-proxy:v1.14.2
k8s.gcr.io/pause:3.1
k8s.gcr.io/etcd:3.3.10
k8s.gcr.io/coredns:1.3.1

<span class="c1"># 修改tag</span>

docker tag docker.io/mirrorgooglecontainers/kube-apiserver:v1.14.2 k8s.gcr.io/kube-apiserver:v1.14.2
docker tag docker.io/mirrorgooglecontainers/kube-scheduler:v1.14.2 k8s.gcr.io/kube-scheduler:v1.14.2
docker tag docker.io/mirrorgooglecontainers/kube-proxy:v1.14.2 k8s.gcr.io/kube-proxy:v1.14.2
docker tag docker.io/mirrorgooglecontainers/kube-controller-manager:v1.14.2 k8s.gcr.io/kube-controller-manager:v1.14.2
docker tag docker.io/mirrorgooglecontainers/etcd:3.3.10  k8s.gcr.io/etcd:3.3.10
docker tag docker.io/mirrorgooglecontainers/pause:3.1  k8s.gcr.io/pause:3.1
docker tag docker.io/coredns/coredns:1.3.1  k8s.gcr.io/coredns:1.3.1

docker rmi <span class="sb">`</span>docker images <span class="p">|</span>grep docker.io/ <span class="p">|</span>awk <span class="s1">&#39;{print $1&quot;:&quot;$2}&#39;</span><span class="sb">`</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>3.2.2 初始化Master<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>使用 kubeadm 初始化 k8s 集群</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm init --kubernetes-version<span class="o">=</span>v1.14.0 --pod-network-cidr<span class="o">=</span><span class="m">10</span>.244.0.0/16 --service-cidr<span class="o">=</span><span class="m">10</span>.96.0.0/12 --ignore-preflight-errors<span class="o">=</span>Swap
</pre></div>
</div>
<ul class="simple">
<li><p>如果有报错使用下面命令查看</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>journalctl -xeu kubelet
</pre></div>
</div>
<ul class="simple">
<li><p>如果初始化过程被中断可以使用下面命令来恢复</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm reset
</pre></div>
</div>
<ul class="simple">
<li><p>下面是最后执行成功显示的结果，需要保存这个执行结果，以让 node
节点加入集群</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p <span class="nv">$HOME</span>/.kube
  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="s2">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join <span class="m">172</span>.16.100.9:6443 --token 2dyd69.hrfsjkkxs4stim7n <span class="se">\</span>
    --discovery-token-ca-cert-hash sha256:4e30c1f41aefb177b708a404ccb7e818e31647c7dbdd2d42f6c5c9894b6f41e7
</pre></div>
</div>
<ul class="simple">
<li><p>最好以普通用户的身份运行下面的命令</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在当前用户家目录下创建.kube目录并配置访问集群的config 文件</span>
mkdir -p <span class="nv">$HOME</span>/.kube
sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</pre></div>
</div>
<ul class="simple">
<li><p>部署 flannel 网络插件</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</pre></div>
</div>
<ul class="simple">
<li><p>查看 kube-system 命名空间中运行的 pods</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get pods -n kube-system
</pre></div>
</div>
<ul class="simple">
<li><p>查看 k8s 集群组件的状态</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get ComponentStatus
</pre></div>
</div>
<ul class="simple">
<li><p>配置命令补全</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>yum install -y bash-completion
<span class="nb">source</span> /usr/share/bash-completion/bash_completion
<span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion bash<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc
</pre></div>
</div>
</div>
</div>
<div class="section" id="node">
<h2>3.3 部署 Node<a class="headerlink" href="#node" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>本小节的所有的操作，只在 Node 节点上进行。</p>
</div></blockquote>
<div class="section" id="id5">
<h3>3.3.1 加入集群<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>加入集群，注意在命令尾部加上 –ignore-preflight-errors=Swap ，以忽略
k8s 对主机 swap 的检查（k8s为了性能所以要求进制 swap ）</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm join <span class="m">172</span>.16.100.9:6443 --token 2dyd69.hrfsjkkxs4stim7n <span class="se">\</span>
    --discovery-token-ca-cert-hash sha256:4e30c1f41aefb177b708a404ccb7e818e31647c7dbdd2d42f6c5c9894b6f41e7 --ignore-preflight-errors<span class="o">=</span>Swap
</pre></div>
</div>
<ul class="simple">
<li><p>返回结果，表示加入集群成功</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="s1">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>3.3.2 查看进度<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>当 node 节点加入 K8S 集群中后，Master 会调度到 Node
节点上一些组件，用于处理集群事务，这些组件没有下载完成之前 Node
节点在集群中还是未就绪状态</p>
<ul class="simple">
<li><p>在 node 执行下面命令，可以查看镜像的下载进度，下面是最终结果显示</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker image ls
REPOSITORY               TAG                 IMAGE ID            CREATED             SIZE
k8s.gcr.io/kube-proxy    v1.14.0             5cd54e388aba        <span class="m">6</span> weeks ago         <span class="m">82</span>.1MB
quay.io/coreos/flannel   v0.11.0-amd64       ff281650a721        <span class="m">3</span> months ago        <span class="m">52</span>.6MB
k8s.gcr.io/pause         <span class="m">3</span>.1                 da86e6ba6ca1        <span class="m">16</span> months ago       742kB
</pre></div>
</div>
<ul class="simple">
<li><p>可以在 Master 上使用下面命令来查看新加入的节点状态</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get nodes
NAME     STATUS   ROLES    AGE     VERSION
master   Ready    master   3d21h   v1.14.1
node1    Ready    &lt;none&gt;   3d21h   v1.14.1
node2    Ready    &lt;none&gt;   3d21h   v1.14.1
</pre></div>
</div>
<ul class="simple">
<li><p>查看集群状态</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl cluster-info </span>
Kubernetes master is running at https://10.234.2.204:6443
KubeDNS is running at https://10.234.2.204:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://10.234.2.204:6443/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy

To further debug and diagnose cluster problems, use <span class="s1">&#39;kubectl cluster-info dump&#39;</span>.
<span class="o">[</span>root@master ~<span class="o">]</span><span class="c1"># kubectl get componentstatuses</span>
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-0               Healthy   <span class="o">{</span><span class="s2">&quot;health&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>   
</pre></div>
</div>
<p>如果嫌网络pull镜像慢可以在一台上面将镜像打包发送至其他node节点</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>拷贝到node节点
for i in /tmp/*.tar; do scp -i $i root@172.16.0.15:/root/;done


node节点还原
for i in *.tar ;do docker load -i $i;done
</pre></div>
</div>
<ul class="simple">
<li><p>查看 kube-system 这个 k8s
命名空间中有哪些组件，分别运行在哪个节点，-o wide 是以详细方式显示。</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -n kube-system -o wide

NAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES
coredns-fb8b8dccf-cp24r              <span class="m">1</span>/1     Running   <span class="m">0</span>          26m     <span class="m">10</span>.244.0.2      i-xeahpl98   &lt;none&gt;           &lt;none&gt;
coredns-fb8b8dccf-ljswp              <span class="m">1</span>/1     Running   <span class="m">0</span>          26m     <span class="m">10</span>.244.0.3      i-xeahpl98   &lt;none&gt;           &lt;none&gt;
etcd-i-xeahpl98                      <span class="m">1</span>/1     Running   <span class="m">0</span>          25m     <span class="m">172</span>.16.100.9    i-xeahpl98   &lt;none&gt;           &lt;none&gt;
kube-apiserver-i-xeahpl98            <span class="m">1</span>/1     Running   <span class="m">0</span>          25m     <span class="m">172</span>.16.100.9    i-xeahpl98   &lt;none&gt;           &lt;none&gt;
kube-controller-manager-i-xeahpl98   <span class="m">1</span>/1     Running   <span class="m">0</span>          25m     <span class="m">172</span>.16.100.9    i-xeahpl98   &lt;none&gt;           &lt;none&gt;
kube-flannel-ds-amd64-crft8          <span class="m">1</span>/1     Running   <span class="m">3</span>          16m     <span class="m">172</span>.16.100.6    i-me87b6gw   &lt;none&gt;           &lt;none&gt;
kube-flannel-ds-amd64-nckw4          <span class="m">1</span>/1     Running   <span class="m">0</span>          6m41s   <span class="m">172</span>.16.100.10   i-qhcc2owe   &lt;none&gt;           &lt;none&gt;
kube-flannel-ds-amd64-zb7sg          <span class="m">1</span>/1     Running   <span class="m">0</span>          23m     <span class="m">172</span>.16.100.9    i-xeahpl98   &lt;none&gt;           &lt;none&gt;
kube-proxy-7kjkf                     <span class="m">1</span>/1     Running   <span class="m">0</span>          6m41s   <span class="m">172</span>.16.100.10   i-qhcc2owe   &lt;none&gt;           &lt;none&gt;
kube-proxy-c5xs2                     <span class="m">1</span>/1     Running   <span class="m">2</span>          16m     <span class="m">172</span>.16.100.6    i-me87b6gw   &lt;none&gt;           &lt;none&gt;
kube-proxy-rdzq2                     <span class="m">1</span>/1     Running   <span class="m">0</span>          26m     <span class="m">172</span>.16.100.9    i-xeahpl98   &lt;none&gt;           &lt;none&gt;
kube-scheduler-i-xeahpl98            <span class="m">1</span>/1     Running   <span class="m">0</span>          25m     <span class="m">172</span>.16.100.9    i-xeahpl98   &lt;none&gt;           &lt;none&gt;
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>3.3.3 镜像下载太慢<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>node 节点需要翻墙下载镜像太慢，建议使用 docker 镜像的导入导出功能
先将master的三个镜像打包发送到node节点，load后再jion</p>
<ul class="simple">
<li><p>导出</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker image save -o /tmp/kube-proxy.tar k8s.gcr.io/kube-proxy
docker image save -o /tmp/flannel.tar quay.io/coreos/flannel
docker image save -o /tmp/pause.tar k8s.gcr.io/pause
</pre></div>
</div>
<ul class="simple">
<li><p>导入</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker image load -i /tmp/kube-proxy.tar
docker image load -i /tmp/pause.tar
docker image load -i /tmp/flannel.tar
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="chapter_4.html" class="btn btn-neutral float-right" title="四 入门命令" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="chapter_2.html" class="btn btn-neutral float-left" title="二 核心组件/附件" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, kaliarch,Zeusro

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>